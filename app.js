// Base de données intégrée des participants (anonymisée)
const participantsDatabase = {
  "5ACD2553": {
    "nom": "Participant 5ACD2553",
    "region": "Inconnue",
    "evenements": [
      {
        "nom": "Circuit Fontaines",
        "horaire": "Lundi 9h30"
      },
      {
        "nom": "Jeu enquête",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Visite Rade Enfant",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Jeu enquête",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "4C513D42": {
    "nom": "Participant 4C513D42",
    "region": "Strasbourg",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "0D082DD8": {
    "nom": "Participant 0D082DD8",
    "region": "Strasbourg",
    "evenements": []
  },
  "A50D6048": {
    "nom": "Participant A50D6048",
    "region": "Strasbourg",
    "evenements": []
  },
  "9F1EE7FD": {
    "nom": "Participant 9F1EE7FD",
    "region": "Inconnue",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "C4E54827": {
    "nom": "Participant C4E54827",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "69F6F1A6": {
    "nom": "Participant 69F6F1A6",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "8557E5C1": {
    "nom": "Participant 8557E5C1",
    "region": "Strasbourg",
    "evenements": []
  },
  "F33369FF": {
    "nom": "Participant F33369FF",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "9CEE997A": {
    "nom": "Participant 9CEE997A",
    "region": "Inconnue",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "807C4B42": {
    "nom": "Participant 807C4B42",
    "region": "Ile-de-France",
    "evenements": []
  },
  "5E0E0C3D": {
    "nom": "Participant 5E0E0C3D",
    "region": "Montpellier",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "9A2E585F": {
    "nom": "Participant 9A2E585F",
    "region": "Montpellier",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "FCC8F114": {
    "nom": "Participant FCC8F114",
    "region": "Grenoble",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "04DDDE57": {
    "nom": "Participant 04DDDE57",
    "region": "Ile-de-France",
    "evenements": []
  },
  "275138CC": {
    "nom": "Participant 275138CC",
    "region": "Haute-Normandie",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "172C1233": {
    "nom": "Participant 172C1233",
    "region": "Grenoble",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Dimanche 14h45"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Lundi 9h30"
      }
    ]
  },
  "BD6122AC": {
    "nom": "Participant BD6122AC",
    "region": "Ile-de-France",
    "evenements": []
  },
  "19708224": {
    "nom": "Participant 19708224",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "DBA020BA": {
    "nom": "Participant DBA020BA",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      }
    ]
  },
  "D4D0C58E": {
    "nom": "Participant D4D0C58E",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "E965CEFA": {
    "nom": "Participant E965CEFA",
    "region": "Poitou-Charentes",
    "evenements": []
  },
  "1B38F994": {
    "nom": "Participant 1B38F994",
    "region": "Inconnue",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      }
    ]
  },
  "B97D0B38": {
    "nom": "Participant B97D0B38",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "293DF7E8": {
    "nom": "Participant 293DF7E8",
    "region": "Bourgogne",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "8F1A6D71": {
    "nom": "Participant 8F1A6D71",
    "region": "Bourgogne",
    "evenements": [
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Lundi 9h30"
      }
    ]
  },
  "9E7AEEBA": {
    "nom": "Participant 9E7AEEBA",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "C8A880C4": {
    "nom": "Participant C8A880C4",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Histoire en musique Enfant",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "7D5FCCC3": {
    "nom": "Participant 7D5FCCC3",
    "region": "Ile-de-France",
    "evenements": []
  },
  "978F432A": {
    "nom": "Participant 978F432A",
    "region": "Lorraine",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "6C3599FE": {
    "nom": "Participant 6C3599FE",
    "region": "Lorraine",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "D1C73274": {
    "nom": "Participant D1C73274",
    "region": "Poitou-Charentes",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "97C13ABE": {
    "nom": "Participant 97C13ABE",
    "region": "Haute-Normandie",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      }
    ]
  },
  "28E10008": {
    "nom": "Participant 28E10008",
    "region": "Haute-Normandie",
    "evenements": []
  },
  "56EF535E": {
    "nom": "Participant 56EF535E",
    "region": "Lorraine",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "D04FF2DA": {
    "nom": "Participant D04FF2DA",
    "region": "Strasbourg",
    "evenements": [
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "C4F142DC": {
    "nom": "Participant C4F142DC",
    "region": "Montpellier",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "140A5A0B": {
    "nom": "Participant 140A5A0B",
    "region": "Picardie",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "E55AFBB7": {
    "nom": "Participant E55AFBB7",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "BA85B2F7": {
    "nom": "Participant BA85B2F7",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      }
    ]
  },
  "998B3E9E": {
    "nom": "Participant 998B3E9E",
    "region": "Aquitaine",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "60262870": {
    "nom": "Participant 60262870",
    "region": "Poitou-Charentes",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "2860519C": {
    "nom": "Participant 2860519C",
    "region": "Montpellier",
    "evenements": [
      {
        "nom": "Histoire en musique Enfant",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Enfant",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      },
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      },
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      },
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "B438B1FC": {
    "nom": "Participant B438B1FC",
    "region": "Ile-de-France",
    "evenements": []
  },
  "7184A326": {
    "nom": "Participant 7184A326",
    "region": "Centre-Val de Loire",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "B64F54A3": {
    "nom": "Participant B64F54A3",
    "region": "Bretagne",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      }
    ]
  },
  "05309F44": {
    "nom": "Participant 05309F44",
    "region": "BELGIQUE",
    "evenements": []
  },
  "4025AE05": {
    "nom": "Participant 4025AE05",
    "region": "Lyon",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "5FA78637": {
    "nom": "Participant 5FA78637",
    "region": "BELGIQUE",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "4B942B07": {
    "nom": "Participant 4B942B07",
    "region": "Inconnue",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "3BE2C592": {
    "nom": "Participant 3BE2C592",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "93B33799": {
    "nom": "Participant 93B33799",
    "region": "Ile-de-France",
    "evenements": []
  },
  "911DD4EA": {
    "nom": "Participant 911DD4EA",
    "region": "Bourgogne",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "F1D2BE79": {
    "nom": "Participant F1D2BE79",
    "region": "Nice-Corse",
    "evenements": []
  },
  "0D8E235B": {
    "nom": "Participant 0D8E235B",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "84CC43B9": {
    "nom": "Participant 84CC43B9",
    "region": "Aquitaine",
    "evenements": [
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "D5923913": {
    "nom": "Participant D5923913",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "DC41146F": {
    "nom": "Participant DC41146F",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "4E5D7EAE": {
    "nom": "Participant 4E5D7EAE",
    "region": "Lyon",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "BC29ECAF": {
    "nom": "Participant BC29ECAF",
    "region": "Bretagne",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "C08E5BC5": {
    "nom": "Participant C08E5BC5",
    "region": "Ile-de-France",
    "evenements": []
  },
  "D03233C8": {
    "nom": "Participant D03233C8",
    "region": "Haute-Normandie",
    "evenements": [
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Dimanche 14h45"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Dimanche 14h45"
      }
    ]
  },
  "CB6DD420": {
    "nom": "Participant CB6DD420",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "ED134260": {
    "nom": "Participant ED134260",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      }
    ]
  },
  "BDC25A19": {
    "nom": "Participant BDC25A19",
    "region": "Poitou-Charentes",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      }
    ]
  },
  "79CB7B03": {
    "nom": "Participant 79CB7B03",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "C72E753C": {
    "nom": "Participant C72E753C",
    "region": "Grenoble",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Lundi 9h30"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "33A1545F": {
    "nom": "Participant 33A1545F",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "9813AC07": {
    "nom": "Participant 9813AC07",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "BCAFC2AA": {
    "nom": "Participant BCAFC2AA",
    "region": "Aquitaine",
    "evenements": []
  },
  "1BC4EB05": {
    "nom": "Participant 1BC4EB05",
    "region": "Lille",
    "evenements": []
  },
  "C2AF630E": {
    "nom": "Participant C2AF630E",
    "region": "Lorraine",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "FD2825BD": {
    "nom": "Participant FD2825BD",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "C25CFB3F": {
    "nom": "Participant C25CFB3F",
    "region": "Aix-Marseille",
    "evenements": []
  },
  "8F9A1E3F": {
    "nom": "Participant 8F9A1E3F",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "45522949": {
    "nom": "Participant 45522949",
    "region": "Grenoble",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "AE4B3DA6": {
    "nom": "Participant AE4B3DA6",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "558D3E86": {
    "nom": "Participant 558D3E86",
    "region": "Ile-de-France",
    "evenements": []
  },
  "563B01B6": {
    "nom": "Participant 563B01B6",
    "region": "Nice-Corse",
    "evenements": []
  },
  "E27CF3E0": {
    "nom": "Participant E27CF3E0",
    "region": "Aquitaine",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "5DC0BC69": {
    "nom": "Participant 5DC0BC69",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "659F87B5": {
    "nom": "Participant 659F87B5",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "097EAD4F": {
    "nom": "Participant 097EAD4F",
    "region": "Toulouse",
    "evenements": []
  },
  "3DEFD357": {
    "nom": "Participant 3DEFD357",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "DFF53324": {
    "nom": "Participant DFF53324",
    "region": "Centre-Val de Loire",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "6F512DE6": {
    "nom": "Participant 6F512DE6",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "76A4D7CB": {
    "nom": "Participant 76A4D7CB",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "E73B56CB": {
    "nom": "Participant E73B56CB",
    "region": "Lorraine",
    "evenements": []
  },
  "23D59C2D": {
    "nom": "Participant 23D59C2D",
    "region": "Nice-Corse",
    "evenements": []
  },
  "DD236F3A": {
    "nom": "Participant DD236F3A",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      }
    ]
  },
  "28D8BB05": {
    "nom": "Participant 28D8BB05",
    "region": "Strasbourg",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Dimanche 14h45"
      }
    ]
  },
  "DE0C8133": {
    "nom": "Participant DE0C8133",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      }
    ]
  },
  "8A186651": {
    "nom": "Participant 8A186651",
    "region": "Centre-Val de Loire",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "D298E4C5": {
    "nom": "Participant D298E4C5",
    "region": "Strasbourg",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "D46A95B0": {
    "nom": "Participant D46A95B0",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "5476FB42": {
    "nom": "Participant 5476FB42",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "241C1FD9": {
    "nom": "Participant 241C1FD9",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "EA367784": {
    "nom": "Participant EA367784",
    "region": "Nice-Corse",
    "evenements": []
  },
  "7D61BD94": {
    "nom": "Participant 7D61BD94",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "504B5A60": {
    "nom": "Participant 504B5A60",
    "region": "Nice-Corse",
    "evenements": []
  },
  "3CF0489C": {
    "nom": "Participant 3CF0489C",
    "region": "Lyon",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Jeu enquête",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "9C16381A": {
    "nom": "Participant 9C16381A",
    "region": "Lyon",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Jeu enquête",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "179A8CFC": {
    "nom": "Participant 179A8CFC",
    "region": "Montpellier",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Dimanche 14h45"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Lundi 9h30"
      },
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "E3326579": {
    "nom": "Participant E3326579",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "A460A6EB": {
    "nom": "Participant A460A6EB",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "FF69E3B5": {
    "nom": "Participant FF69E3B5",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      }
    ]
  },
  "374ADAC7": {
    "nom": "Participant 374ADAC7",
    "region": "Grenoble",
    "evenements": []
  }
};
// Configuration Supabase
const supabaseUrl = 'https://nbrutmsaunnenjbccpmb.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5icnV0bXNhdW5uZW5qYmNjcG1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MDQ2MDAsImV4cCI6MjA2NzQ4MDYwMH0.NoObPP9vpl-ME0f8oYwXVtf6nuTpVbmEuoWMmbyCrL4'

// Initialisation des variables globales
let supabase = null;
let html5QrCode = null;
let currentParticipant = null;
let validationsData = {};
let realtimeChannel = null;

// Initialisation de l'application
document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
  initializeEventListeners();
  initializeSupabase();
});

// Initialisation des événements
function initializeEventListeners() {
  // Gestion des onglets
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', function() {
      const tabName = this.dataset.tab;
      switchTab(tabName);
    });
  });

  // Scanner QR
  document.getElementById('startScan').addEventListener('click', startQRScanner);
  document.getElementById('stopScan').addEventListener('click', stopQRScanner);
  document.getElementById('qr-file-input').addEventListener('change', handleFileUpload);

  // Recherche par ID
  document.getElementById('searchBtn').addEventListener('click', searchParticipant);
  document.getElementById('searchId').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchParticipant();
    }
  });

  // Boutons de test
  document.querySelectorAll('.test-id-btn').forEach(button => {
    button.addEventListener('click', function() {
      const testId = this.dataset.id;
      displayParticipant(testId);
    });
  });

  document.getElementById('testConnection').addEventListener('click', testSupabaseConnection);
}

// Initialisation de l'application
function initializeApp() {
  updateConnectionStatus('Initialisation...', 'info');
  loadValidationsData();
  updateStatistics();
}

// Initialisation de Supabase
async function initializeSupabase() {
  try {
    if (supabaseUrl === 'VOTRE_SUPABASE_URL' || supabaseKey === 'VOTRE_SUPABASE_ANON_KEY') {
      updateConnectionStatus('Configuration Supabase requise', 'warning');
      return;
    }
	supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Authentification anonyme
    const { data, error } = await supabase.auth.signInAnonymously();

    if (error) {
      throw error;
    }

    updateConnectionStatus('Connecté à Supabase', 'success');

    // Charger les données existantes
    await loadValidationsFromSupabase();

    // Initialiser les subscriptions en temps réel
    initializeRealtimeSubscriptions();

  } catch (error) {
    console.error('Erreur initialisation Supabase:', error);
    updateConnectionStatus('Erreur connexion Supabase', 'error');
  }
}


// Gestion des onglets
function switchTab(tabName) {
  // Mise à jour des boutons
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.remove('active');
  });
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

  // Mise à jour du contenu
  document.querySelectorAll('.tab-panel').forEach(panel => {
    panel.classList.remove('active');
  });
  document.getElementById(tabName).classList.add('active');

  // Mise à jour des statistiques si on va sur l'onglet statistiques
  if (tabName === 'statistiques') {
    updateStatistics();
  }
}

// Scanner QR
function startQRScanner() {
  const qrReaderElement = document.getElementById('qr-reader');

  if (!html5QrCode) {
    html5QrCode = new Html5Qrcode("qr-reader");
  }

  const config = {
    fps: 10,
    qrbox: { width: 250, height: 250 },
    aspectRatio: 1.0
  };

  html5QrCode.start(
    { facingMode: "environment" },
    config,
    (decodedText) => {
      handleQRCodeResult(decodedText);
    },
    (errorMessage) => {
      // Ignorer les erreurs de scan normales
    }
  ).then(() => {
    document.getElementById('startScan').classList.add('hidden');
    document.getElementById('stopScan').classList.remove('hidden');
  }).catch(err => {
    console.error('Erreur démarrage scanner:', err);
    showScanResult('Erreur: Impossible d\'accéder à la caméra', 'error');
  });
}

function stopQRScanner() {
  if (html5QrCode) {
    html5QrCode.stop().then(() => {
      document.getElementById('startScan').classList.remove('hidden');
      document.getElementById('stopScan').classList.add('hidden');
    }).catch(err => {
      console.error('Erreur arrêt scanner:', err);
    });
  }
}

function handleFileUpload(event) {
  const file = event.target.files[0];
  if (file) {
    if (!html5QrCode) {
      html5QrCode = new Html5Qrcode("qr-reader");
    }

    html5QrCode.scanFile(file, true)
      .then(decodedText => {
        handleQRCodeResult(decodedText);
      })
      .catch(err => {
        showScanResult('Erreur: Aucun QR code détecté dans l\'image', 'error');
      });
  }
}

function handleQRCodeResult(decodedText) {
  showScanResult(`QR Code détecté: ${decodedText}`, 'success');
  displayParticipant(decodedText);
}

function showScanResult(message, type) {
  const resultDiv = document.getElementById('scan-result');
  resultDiv.textContent = message;
  resultDiv.className = `scan-result test-result ${type}`;
  resultDiv.classList.remove('hidden');
}

// Recherche par ID
function searchParticipant() {
  const searchId = document.getElementById('searchId').value.trim();
  if (!searchId) {
    showSearchResult('Veuillez entrer un ID', 'error');
    return;
  }

  displayParticipant(searchId);
}

function showSearchResult(message, type) {
  const resultDiv = document.getElementById('search-result');
  resultDiv.textContent = message;
  resultDiv.className = `search-result test-result ${type}`;
  resultDiv.classList.remove('hidden');
}

// Affichage des participants
function displayParticipant(participantId) {
  const participant = participantsDatabase[participantId];

  if (!participant) {
    showSearchResult('Participant non trouvé', 'error');
    return;
  }

  currentParticipant = participantId;

  // Mettre à jour l'interface
  document.getElementById('participantName').textContent = participant.nom;
  document.getElementById('participantRegion').textContent = `Région: ${participant.region}`;

  // Afficher les événements
  displayEvents(participantId, participant.evenements);

  // Afficher la section participant
  document.getElementById('participantDisplay').classList.remove('hidden');

  showSearchResult(`Participant ${participantId} trouvé`, 'success');
}

function displayEvents(participantId, events) {
  const eventsList = document.getElementById('eventsList');
  eventsList.innerHTML = '';

  if (events.length === 0) {
    eventsList.innerHTML = '<p>Aucun événement pour ce participant.</p>';
    return;
  }

  events.forEach((event, index) => {
    const eventDiv = document.createElement('div');
    eventDiv.className = 'event-item';
    eventDiv.setAttribute('tabindex', '0');

    const status = getEventStatus(participantId, index);
    eventDiv.classList.add(status);

    eventDiv.innerHTML = `
      <div class="event-info">
        <div class="event-name">${event.nom}</div>
        <div class="event-schedule">${event.horaire}</div>
      </div>
      <div class="event-status ${status}">
        ${getStatusLabel(status)}
      </div>
      <div class="sync-indicator" style="display: none;"></div>
    `;

    eventDiv.addEventListener('click', () => toggleEventStatus(participantId, index));
    eventDiv.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleEventStatus(participantId, index);
      }
    });

    eventsList.appendChild(eventDiv);
  });
}

function getEventStatus(participantId, eventIndex) {
  const key = `${participantId}-${eventIndex}`;
  return validationsData[key] || 'none';
}

function getStatusLabel(status) {
  switch(status) {
    case 'validated': return 'Validé';
    case 'invalidated': return 'Invalidé';
    default: return 'Non traité';
  }
}

function toggleEventStatus(participantId, eventIndex) {
  const currentStatus = getEventStatus(participantId, eventIndex);
  let newStatus;

  // Cycle: none -> validated -> invalidated -> none
  switch(currentStatus) {
    case 'none': newStatus = 'validated'; break;
    case 'validated': newStatus = 'invalidated'; break;
    case 'invalidated': newStatus = 'none'; break;
    default: newStatus = 'validated';
  }

  updateEventValidation(participantId, eventIndex, newStatus);
}

async function updateEventValidation(participantId, eventIndex, status) {
  const key = `${participantId}-${eventIndex}`;
  const syncIndicator = document.querySelector(`[data-key="${key}"] .sync-indicator`);

  // Mise à jour optimiste de l'interface
  validationsData[key] = status;
  updateEventDisplay(participantId, eventIndex, status);

  // Afficher l'indicateur de synchronisation
  if (syncIndicator) {
    syncIndicator.style.display = 'block';
    syncIndicator.classList.add('syncing');
  }

  // Sauvegarder dans Supabase
  if (supabase) {
    try {
      const { error } = await supabase
        .from('event_validations')
        .upsert({
          participant_id: participantId,
          event_index: eventIndex,
          status: status,
          validated_at: new Date().toISOString()
        });

      if (error) throw error;

      // Synchronisation réussie
      if (syncIndicator) {
        syncIndicator.classList.remove('syncing');
        setTimeout(() => {
          syncIndicator.style.display = 'none';
        }, 1000);
      }

    } catch (error) {
      console.error('Erreur sauvegarde:', error);

      // Afficher l'erreur
      if (syncIndicator) {
        syncIndicator.classList.remove('syncing');
        syncIndicator.classList.add('error');
      }
    }
  }

  // Mettre à jour les statistiques
  updateStatistics();
}

function updateEventDisplay(participantId, eventIndex, status) {
  const eventsList = document.getElementById('eventsList');
  const eventItems = eventsList.querySelectorAll('.event-item');

  if (eventItems[eventIndex]) {
    const eventItem = eventItems[eventIndex];
    const statusElement = eventItem.querySelector('.event-status');

    // Mettre à jour les classes
    eventItem.className = `event-item ${status}`;
    statusElement.className = `event-status ${status}`;
    statusElement.textContent = getStatusLabel(status);
  }
}

// Chargement des données depuis Supabase
async function loadValidationsFromSupabase() {
  if (!supabase) return;

  try {
    const { data, error } = await supabase
      .from('event_validations')
      .select('*');

    if (error) throw error;

    // Mettre à jour les données locales
    data.forEach(validation => {
      const key = `${validation.participant_id}-${validation.event_index}`;
      validationsData[key] = validation.status;
    });

    // Mettre à jour l'affichage si un participant est sélectionné
    if (currentParticipant) {
      const participant = participantsDatabase[currentParticipant];
      if (participant) {
        displayEvents(currentParticipant, participant.evenements);
      }
    }

    updateStatistics();

  } catch (error) {
    console.error('Erreur chargement données:', error);
  }
}

// Subscriptions en temps réel
function initializeRealtimeSubscriptions() {
  if (!supabase) return;

  realtimeChannel = supabase
    .channel('validations')
    .on('postgres_changes',
      { event: '*', schema: 'public', table: 'event_validations' },
      handleRealTimeUpdate
    )
    .subscribe();
}

function handleRealTimeUpdate(payload) {
  const { eventType, new: newRecord, old: oldRecord } = payload;

  if (eventType === 'INSERT' || eventType === 'UPDATE') {
    const key = `${newRecord.participant_id}-${newRecord.event_index}`;
    validationsData[key] = newRecord.status;

    // Mettre à jour l'affichage si c'est le participant actuel
    if (currentParticipant === newRecord.participant_id) {
      updateEventDisplay(newRecord.participant_id, newRecord.event_index, newRecord.status);
    }
  }

  updateStatistics();
}

// Chargement des données locales
function loadValidationsData() {
  // Ici on pourrait charger depuis une source locale si nécessaire
  // Pour l'instant, on initialise avec des données vides
  validationsData = {};
}

// Mise à jour des statistiques
function updateStatistics() {
  const stats = calculateStatistics();

  document.getElementById('totalValidations').textContent = stats.totalValidations;
  document.getElementById('totalInvalidations').textContent = stats.totalInvalidations;
  document.getElementById('validationRate').textContent = `${stats.validationRate}%`;

  displayEventStatistics(stats.eventStats);
}


function calculateStatistics() {
  const stats = {
    totalValidations: 0,
    totalInvalidations: 0,
    validationRate: 0,
    eventStats: {}
  };

  // Analyser toutes les validations
  Object.values(validationsData).forEach(status => {
    if (status === 'validated') {
      stats.totalValidations++;
    } else if (status === 'invalidated') {
      stats.totalInvalidations++;
    }
  });

  // Calculer le taux de validation
  const total = stats.totalValidations + stats.totalInvalidations;
  if (total > 0) {
    stats.validationRate = Math.round((stats.totalValidations / total) * 100);
  }

  // Statistiques par événement
  Object.keys(participantsDatabase).forEach(participantId => {
    const participant = participantsDatabase[participantId];
    participant.evenements.forEach((event, index) => {
	  // Si c'est un repas, on forme un nom unique "Repas APMEP (Lundi midi)"
		let eventName = event.nom;
		if (event.nom && event.nom.toLowerCase().includes("repas") && event.horaire) {
			eventName = event.nom + " (" + event.horaire + ")";
		}
		if (!stats.eventStats[eventName]) {
			stats.eventStats[eventName] = {
			validated: 0,
			invalidated: 0,
			none: 0
			};
      }

      const status = getEventStatus(participantId, index);
      stats.eventStats[eventName][status]++;

    });
  });

  return stats;
}

function displayEventStatistics(eventStats) {
  const eventStatsDiv = document.getElementById('eventStats');
  eventStatsDiv.innerHTML = '';

  Object.entries(eventStats).forEach(([eventName, counts]) => {
    const total = counts.validated + counts.invalidated + counts.none;
    const validationRate = total > 0 ? Math.round((counts.validated / total) * 100) : 0;

    const statDiv = document.createElement('div');
    statDiv.className = 'event-stat';
    statDiv.innerHTML = `
      <div class="event-stat-name">${eventName}</div>
      <div class="event-stat-counts">
        <div class="stat-count validated">
          ✓ ${counts.validated}
        </div>
        <div class="stat-count invalidated">
          ✗ ${counts.invalidated}
        </div>
        <div class="stat-count none">
          ○ ${counts.none}
        </div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${validationRate}%"></div>
      </div>
    `;

    eventStatsDiv.appendChild(statDiv);
  });
}

// Test de connexion Supabase
async function testSupabaseConnection() {
  const testButton = document.getElementById('testConnection');
  const resultDiv = document.getElementById('connectionTest');

  testButton.textContent = 'Test en cours...';
  testButton.disabled = true;

  try {
    if (!supabase) {
      throw new Error('Supabase non initialisé');
    }

    // Test simple de lecture
    const { data, error } = await supabase
      .from('event_validations')
      .select('count', { count: 'exact' });

    if (error) throw error;

    resultDiv.textContent = `Connexion réussie! ${data.length} enregistrements trouvés.`;
    resultDiv.className = 'test-result success';

  } catch (error) {
    resultDiv.textContent = `Erreur de connexion: ${error.message}`;
    resultDiv.className = 'test-result error';
  } finally {
    testButton.textContent = 'Tester connexion';
    testButton.disabled = false;
    resultDiv.classList.remove('hidden');
  }
}

// Mise à jour du statut de connexion
function updateConnectionStatus(message, type) {
  const statusElement = document.getElementById('connectionStatus');
  statusElement.textContent = message;
  statusElement.className = `status status--${type}`;
}

// Nettoyage à la fermeture
window.addEventListener('beforeunload', () => {
  if (html5QrCode) {
    html5QrCode.stop().catch(err => console.error('Erreur arrêt scanner:', err));
  }

  if (realtimeChannel) {
    realtimeChannel.unsubscribe();
  }
});
