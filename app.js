// Base de données intégrée des participants (anonymisée)
const participantsDatabase = {
  "1CC892B8": {
    "nom": "Participant 1CC892B8",
    "region": "Inconnue",
    "evenements": [
      {
        "nom": "Histoire en musique Enfant",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      },
      {
        "nom": "Visite Rade Enfant",
        "horaire": "Dimanche 14h45"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Dimanche 14h45"
      }
    ]
  },
  "746121D6": {
    "nom": "Participant 746121D6",
    "region": "Inconnue",
    "evenements": [
      {
        "nom": "Circuit Fontaines",
        "horaire": "Lundi 9h30"
      },
      {
        "nom": "Jeu enquête",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Visite Rade Enfant",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Jeu enquête",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "501B7467": {
    "nom": "Participant 501B7467",
    "region": "Strasbourg",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "4DABD296": {
    "nom": "Participant 4DABD296",
    "region": "Strasbourg",
    "evenements": []
  },
  "AD98E74B": {
    "nom": "Participant AD98E74B",
    "region": "Strasbourg",
    "evenements": []
  },
  "508A733A": {
    "nom": "Participant 508A733A",
    "region": "Inconnue",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "57BDDEF3": {
    "nom": "Participant 57BDDEF3",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "79661910": {
    "nom": "Participant 79661910",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "FEB6ABA7": {
    "nom": "Participant FEB6ABA7",
    "region": "Strasbourg",
    "evenements": []
  },
  "3A2319F6": {
    "nom": "Participant 3A2319F6",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "D6FCBC50": {
    "nom": "Participant D6FCBC50",
    "region": "Inconnue",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "925534E4": {
    "nom": "Participant 925534E4",
    "region": "Ile-de-France",
    "evenements": []
  },
  "6DD05E0D": {
    "nom": "Participant 6DD05E0D",
    "region": "Montpellier",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "7C40C873": {
    "nom": "Participant 7C40C873",
    "region": "Montpellier",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "9B5EF5E8": {
    "nom": "Participant 9B5EF5E8",
    "region": "Grenoble",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "82BC7799": {
    "nom": "Participant 82BC7799",
    "region": "Ile-de-France",
    "evenements": []
  },
  "29DED163": {
    "nom": "Participant 29DED163",
    "region": "Haute-Normandie",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "DD2ADF4E": {
    "nom": "Participant DD2ADF4E",
    "region": "Grenoble",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Dimanche 14h45"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Lundi 9h30"
      }
    ]
  },
  "4E46AC0A": {
    "nom": "Participant 4E46AC0A",
    "region": "Ile-de-France",
    "evenements": []
  },
  "BF06A4D3": {
    "nom": "Participant BF06A4D3",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "87E15B57": {
    "nom": "Participant 87E15B57",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      }
    ]
  },
  "7B9EFF85": {
    "nom": "Participant 7B9EFF85",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "C1B30091": {
    "nom": "Participant C1B30091",
    "region": "Poitou-Charentes",
    "evenements": []
  },
  "AE3E692F": {
    "nom": "Participant AE3E692F",
    "region": "Inconnue",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      }
    ]
  },
  "88CD1D41": {
    "nom": "Participant 88CD1D41",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "86836FA3": {
    "nom": "Participant 86836FA3",
    "region": "Bourgogne",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "EE3FB523": {
    "nom": "Participant EE3FB523",
    "region": "Bourgogne",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "2B07BDB8": {
    "nom": "Participant 2B07BDB8",
    "region": "Bourgogne",
    "evenements": [
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Lundi 9h30"
      }
    ]
  },
  "00119755": {
    "nom": "Participant 00119755",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "9AA7CC22": {
    "nom": "Participant 9AA7CC22",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Histoire en musique Enfant",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "33AE0272": {
    "nom": "Participant 33AE0272",
    "region": "Ile-de-France",
    "evenements": []
  },
  "5C285658": {
    "nom": "Participant 5C285658",
    "region": "Lorraine",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "B88989D9": {
    "nom": "Participant B88989D9",
    "region": "Lorraine",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "8BC69788": {
    "nom": "Participant 8BC69788",
    "region": "Poitou-Charentes",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "1C170BE7": {
    "nom": "Participant 1C170BE7",
    "region": "Haute-Normandie",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      }
    ]
  },
  "ADF720B4": {
    "nom": "Participant ADF720B4",
    "region": "Haute-Normandie",
    "evenements": []
  },
  "B60F3834": {
    "nom": "Participant B60F3834",
    "region": "Lorraine",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "64AA5017": {
    "nom": "Participant 64AA5017",
    "region": "Strasbourg",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Visite Rade Enfant",
        "horaire": "Dimanche 14h45"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Dimanche 14h45"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Dimanche 14h45"
      }
    ]
  },
  "21426680": {
    "nom": "Participant 21426680",
    "region": "Strasbourg",
    "evenements": [
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "835614CF": {
    "nom": "Participant 835614CF",
    "region": "Montpellier",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "35363108": {
    "nom": "Participant 35363108",
    "region": "Picardie",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "4B41FD2F": {
    "nom": "Participant 4B41FD2F",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "F3F38339": {
    "nom": "Participant F3F38339",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      }
    ]
  },
  "05860070": {
    "nom": "Participant 05860070",
    "region": "Aquitaine",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "3CDEA77C": {
    "nom": "Participant 3CDEA77C",
    "region": "Poitou-Charentes",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "C63C0300": {
    "nom": "Participant C63C0300",
    "region": "Montpellier",
    "evenements": [
      {
        "nom": "Histoire en musique Enfant",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Enfant",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      },
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      },
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      },
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "CFB04B98": {
    "nom": "Participant CFB04B98",
    "region": "Ile-de-France",
    "evenements": []
  },
  "45E92CD4": {
    "nom": "Participant 45E92CD4",
    "region": "Centre-Val de Loire",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "3F767438": {
    "nom": "Participant 3F767438",
    "region": "Bretagne",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      }
    ]
  },
  "03A36312": {
    "nom": "Participant 03A36312",
    "region": "BELGIQUE",
    "evenements": []
  },
  "19773F03": {
    "nom": "Participant 19773F03",
    "region": "Lyon",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "35198C81": {
    "nom": "Participant 35198C81",
    "region": "BELGIQUE",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "24E87645": {
    "nom": "Participant 24E87645",
    "region": "Inconnue",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "3F0C3389": {
    "nom": "Participant 3F0C3389",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "3B9449AA": {
    "nom": "Participant 3B9449AA",
    "region": "Ile-de-France",
    "evenements": []
  },
  "04B64254": {
    "nom": "Participant 04B64254",
    "region": "Bourgogne",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "F55DF67D": {
    "nom": "Participant F55DF67D",
    "region": "Nice-Corse",
    "evenements": []
  },
  "63F17E4F": {
    "nom": "Participant 63F17E4F",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "12955392": {
    "nom": "Participant 12955392",
    "region": "Aquitaine",
    "evenements": [
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "B291EB66": {
    "nom": "Participant B291EB66",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "A7641B73": {
    "nom": "Participant A7641B73",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "0DEB97BF": {
    "nom": "Participant 0DEB97BF",
    "region": "Lyon",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "2FFEDAD9": {
    "nom": "Participant 2FFEDAD9",
    "region": "Bretagne",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "82983189": {
    "nom": "Participant 82983189",
    "region": "Ile-de-France",
    "evenements": []
  },
  "BFB97C8D": {
    "nom": "Participant BFB97C8D",
    "region": "Haute-Normandie",
    "evenements": [
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Dimanche 14h45"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Dimanche 14h45"
      }
    ]
  },
  "D5F16F78": {
    "nom": "Participant D5F16F78",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "136FB0D9": {
    "nom": "Participant 136FB0D9",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      }
    ]
  },
  "56C99F1E": {
    "nom": "Participant 56C99F1E",
    "region": "Poitou-Charentes",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      }
    ]
  },
  "D923F3A5": {
    "nom": "Participant D923F3A5",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "A86CDB4D": {
    "nom": "Participant A86CDB4D",
    "region": "Grenoble",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Lundi 9h30"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "4E7BE404": {
    "nom": "Participant 4E7BE404",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Mardi 13h30"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "3AF0E3DC": {
    "nom": "Participant 3AF0E3DC",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "C8109300": {
    "nom": "Participant C8109300",
    "region": "Aquitaine",
    "evenements": []
  },
  "963C1664": {
    "nom": "Participant 963C1664",
    "region": "Lille",
    "evenements": []
  },
  "C6323623": {
    "nom": "Participant C6323623",
    "region": "Lorraine",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "A0752FC5": {
    "nom": "Participant A0752FC5",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "FABEC489": {
    "nom": "Participant FABEC489",
    "region": "Aix-Marseille",
    "evenements": []
  },
  "986378A6": {
    "nom": "Participant 986378A6",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "3C69A8DC": {
    "nom": "Participant 3C69A8DC",
    "region": "Grenoble",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "1418CA61": {
    "nom": "Participant 1418CA61",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "329C2467": {
    "nom": "Participant 329C2467",
    "region": "Ile-de-France",
    "evenements": []
  },
  "0E8AB7FD": {
    "nom": "Participant 0E8AB7FD",
    "region": "Nice-Corse",
    "evenements": []
  },
  "8FDB4FA0": {
    "nom": "Participant 8FDB4FA0",
    "region": "Aquitaine",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "76FAF8BF": {
    "nom": "Participant 76FAF8BF",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "A091DEB1": {
    "nom": "Participant A091DEB1",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "2692280B": {
    "nom": "Participant 2692280B",
    "region": "Toulouse",
    "evenements": []
  },
  "BAA46469": {
    "nom": "Participant BAA46469",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "4DF10315": {
    "nom": "Participant 4DF10315",
    "region": "Centre-Val de Loire",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "90E32CB0": {
    "nom": "Participant 90E32CB0",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "9F89399C": {
    "nom": "Participant 9F89399C",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "390BCAEC": {
    "nom": "Participant 390BCAEC",
    "region": "Lorraine",
    "evenements": []
  },
  "AEF5DB19": {
    "nom": "Participant AEF5DB19",
    "region": "Nice-Corse",
    "evenements": []
  },
  "4C19E937": {
    "nom": "Participant 4C19E937",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      }
    ]
  },
  "FE9D80B0": {
    "nom": "Participant FE9D80B0",
    "region": "Strasbourg",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Dimanche 14h45"
      }
    ]
  },
  "45147ECE": {
    "nom": "Participant 45147ECE",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Repas Festif",
        "horaire": "Lundi 19h30"
      }
    ]
  },
  "A0A268EE": {
    "nom": "Participant A0A268EE",
    "region": "Centre-Val de Loire",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Visite SHD",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "FA13B6A3": {
    "nom": "Participant FA13B6A3",
    "region": "Strasbourg",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "FCD99044": {
    "nom": "Participant FCD99044",
    "region": "Aix-Marseille",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "415568DA": {
    "nom": "Participant 415568DA",
    "region": "Ile-de-France",
    "evenements": [
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "32842A5B": {
    "nom": "Participant 32842A5B",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      }
    ]
  },
  "101355F6": {
    "nom": "Participant 101355F6",
    "region": "Nice-Corse",
    "evenements": []
  },
  "D191D1F2": {
    "nom": "Participant D191D1F2",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "A7830250": {
    "nom": "Participant A7830250",
    "region": "Nice-Corse",
    "evenements": []
  },
  "112D5584": {
    "nom": "Participant 112D5584",
    "region": "Lyon",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Jeu enquête",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Conférence L1-02",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "0A2107AB": {
    "nom": "Participant 0A2107AB",
    "region": "Lyon",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Mardi midi"
      },
      {
        "nom": "Jeu enquête",
        "horaire": "Mardi 14h"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Mardi 14h"
      }
    ]
  },
  "A6A9FB85": {
    "nom": "Participant A6A9FB85",
    "region": "Montpellier",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      },
      {
        "nom": "Découverte ville",
        "horaire": "Dimanche 9h15"
      },
      {
        "nom": "Visite Rade Adulte",
        "horaire": "Dimanche 14h45"
      },
      {
        "nom": "Circuit Fontaines",
        "horaire": "Lundi 9h30"
      },
      {
        "nom": "Conférence L1-01",
        "horaire": "Lundi 8h30"
      }
    ]
  },
  "5D89C059": {
    "nom": "Participant 5D89C059",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "7DBD0D0D": {
    "nom": "Participant 7DBD0D0D",
    "region": "Toulouse",
    "evenements": [
      {
        "nom": "Repas APMEP",
        "horaire": "Dimanche midi"
      },
      {
        "nom": "Repas APMEP",
        "horaire": "Lundi midi"
      }
    ]
  },
  "0AFCE495": {
    "nom": "Participant 0AFCE495",
    "region": "Nice-Corse",
    "evenements": [
      {
        "nom": "Histoire en musique Adulte",
        "horaire": "Samedi 20h30"
      }
    ]
  },
  "1972B30D": {
    "nom": "Participant 1972B30D",
    "region": "Grenoble",
    "evenements": []
  }
};
// Configuration Supabase
const supabaseUrl = 'https://nbrutmsaunnenjbccpmb.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5icnV0bXNhdW5uZW5qYmNjcG1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MDQ2MDAsImV4cCI6MjA2NzQ4MDYwMH0.NoObPP9vpl-ME0f8oYwXVtf6nuTpVbmEuoWMmbyCrL4'

// Initialisation des variables globales
let supabase = null;
let html5QrCode = null;
let currentParticipant = null;
let validationsData = {};
let realtimeChannel = null;

// Initialisation de l'application
document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
  initializeEventListeners();
  initializeSupabase();
});

// Initialisation des événements
function initializeEventListeners() {
  // Gestion des onglets
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', function() {
      const tabName = this.dataset.tab;
      switchTab(tabName);
    });
  });

  // Scanner QR
  document.getElementById('startScan').addEventListener('click', startQRScanner);
  document.getElementById('stopScan').addEventListener('click', stopQRScanner);
  document.getElementById('qr-file-input').addEventListener('change', handleFileUpload);

  // Recherche par ID
  document.getElementById('searchBtn').addEventListener('click', searchParticipant);
  document.getElementById('searchId').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchParticipant();
    }
  });

  // Boutons de test
  document.querySelectorAll('.test-id-btn').forEach(button => {
    button.addEventListener('click', function() {
      const testId = this.dataset.id;
      displayParticipant(testId);
    });
  });

  document.getElementById('testConnection').addEventListener('click', testSupabaseConnection);
}

// Initialisation de l'application
function initializeApp() {
  updateConnectionStatus('Initialisation...', 'info');
  loadValidationsData();
  updateStatistics();
}

// Initialisation de Supabase
async function initializeSupabase() {
  try {
    if (supabaseUrl === 'VOTRE_SUPABASE_URL' || supabaseKey === 'VOTRE_SUPABASE_ANON_KEY') {
      updateConnectionStatus('Configuration Supabase requise', 'warning');
      return;
    }
	supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Authentification anonyme
    const { data, error } = await supabase.auth.signInAnonymously();

    if (error) {
      throw error;
    }

    updateConnectionStatus('Connecté à Supabase', 'success');

    // Charger les données existantes
    await loadValidationsFromSupabase();

    // Initialiser les subscriptions en temps réel
    initializeRealtimeSubscriptions();

  } catch (error) {
    console.error('Erreur initialisation Supabase:', error);
    updateConnectionStatus('Erreur connexion Supabase', 'error');
  }
}


// Gestion des onglets
function switchTab(tabName) {
  // Mise à jour des boutons
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.remove('active');
  });
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

  // Mise à jour du contenu
  document.querySelectorAll('.tab-panel').forEach(panel => {
    panel.classList.remove('active');
  });
  document.getElementById(tabName).classList.add('active');

  // Mise à jour des statistiques si on va sur l'onglet statistiques
  if (tabName === 'statistiques') {
    updateStatistics();
  }
}

// Scanner QR
function startQRScanner() {
  const qrReaderElement = document.getElementById('qr-reader');

  if (!html5QrCode) {
    html5QrCode = new Html5Qrcode("qr-reader");
  }

  const config = {
    fps: 10,
    qrbox: { width: 250, height: 250 },
    aspectRatio: 1.0
  };

  html5QrCode.start(
    { facingMode: "environment" },
    config,
    (decodedText) => {
      handleQRCodeResult(decodedText);
    },
    (errorMessage) => {
      // Ignorer les erreurs de scan normales
    }
  ).then(() => {
    document.getElementById('startScan').classList.add('hidden');
    document.getElementById('stopScan').classList.remove('hidden');
  }).catch(err => {
    console.error('Erreur démarrage scanner:', err);
    showScanResult('Erreur: Impossible d\'accéder à la caméra', 'error');
  });
}

function stopQRScanner() {
  if (html5QrCode) {
    html5QrCode.stop().then(() => {
      document.getElementById('startScan').classList.remove('hidden');
      document.getElementById('stopScan').classList.add('hidden');
    }).catch(err => {
      console.error('Erreur arrêt scanner:', err);
    });
  }
}

function handleFileUpload(event) {
  const file = event.target.files[0];
  if (file) {
    if (!html5QrCode) {
      html5QrCode = new Html5Qrcode("qr-reader");
    }

    html5QrCode.scanFile(file, true)
      .then(decodedText => {
        handleQRCodeResult(decodedText);
      })
      .catch(err => {
        showScanResult('Erreur: Aucun QR code détecté dans l\'image', 'error');
      });
  }
}

function handleQRCodeResult(decodedText) {
  showScanResult(`QR Code détecté: ${decodedText}`, 'success');
  displayParticipant(decodedText);
}

function showScanResult(message, type) {
  const resultDiv = document.getElementById('scan-result');
  resultDiv.textContent = message;
  resultDiv.className = `scan-result test-result ${type}`;
  resultDiv.classList.remove('hidden');
}

// Recherche par ID
function searchParticipant() {
  const searchId = document.getElementById('searchId').value.trim();
  if (!searchId) {
    showSearchResult('Veuillez entrer un ID', 'error');
    return;
  }

  displayParticipant(searchId);
}

function showSearchResult(message, type) {
  const resultDiv = document.getElementById('search-result');
  resultDiv.textContent = message;
  resultDiv.className = `search-result test-result ${type}`;
  resultDiv.classList.remove('hidden');
}

// Affichage des participants
function displayParticipant(participantId) {
  const participant = participantsDatabase[participantId];

  if (!participant) {
    showSearchResult('Participant non trouvé', 'error');
    return;
  }

  currentParticipant = participantId;

  // Mettre à jour l'interface
  document.getElementById('participantName').textContent = participant.nom;
  document.getElementById('participantRegion').textContent = `Région: ${participant.region}`;

  // Afficher les événements
  displayEvents(participantId, participant.evenements);

  // Afficher la section participant
  document.getElementById('participantDisplay').classList.remove('hidden');

  showSearchResult(`Participant ${participantId} trouvé`, 'success');
}

function displayEvents(participantId, events) {
  const eventsList = document.getElementById('eventsList');
  eventsList.innerHTML = '';

  if (events.length === 0) {
    eventsList.innerHTML = '<p>Aucun événement pour ce participant.</p>';
    return;
  }

  events.forEach((event, index) => {
    const eventDiv = document.createElement('div');
    eventDiv.className = 'event-item';
    eventDiv.setAttribute('tabindex', '0');

    const status = getEventStatus(participantId, index);
    eventDiv.classList.add(status);

    eventDiv.innerHTML = `
      <div class="event-info">
        <div class="event-name">${event.nom}</div>
        <div class="event-schedule">${event.horaire}</div>
      </div>
      <div class="event-status ${status}">
        ${getStatusLabel(status)}
      </div>
      <div class="sync-indicator" style="display: none;"></div>
    `;

    eventDiv.addEventListener('click', () => toggleEventStatus(participantId, index));
    eventDiv.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleEventStatus(participantId, index);
      }
    });

    eventsList.appendChild(eventDiv);
  });
}

function getEventStatus(participantId, eventIndex) {
  const key = `${participantId}-${eventIndex}`;
  return validationsData[key] || 'none';
}

function getStatusLabel(status) {
  switch(status) {
    case 'validated': return 'Validé';
    case 'invalidated': return 'Invalidé';
    default: return 'Non traité';
  }
}

function toggleEventStatus(participantId, eventIndex) {
  const currentStatus = getEventStatus(participantId, eventIndex);
  let newStatus;

  // Cycle: none -> validated -> invalidated -> none
  switch(currentStatus) {
    case 'none': newStatus = 'validated'; break;
    case 'validated': newStatus = 'invalidated'; break;
    case 'invalidated': newStatus = 'none'; break;
    default: newStatus = 'validated';
  }

  updateEventValidation(participantId, eventIndex, newStatus);
}

async function updateEventValidation(participantId, eventIndex, status) {
  const key = `${participantId}-${eventIndex}`;
  const syncIndicator = document.querySelector(`[data-key="${key}"] .sync-indicator`);

  // Mise à jour optimiste de l'interface
  validationsData[key] = status;
  updateEventDisplay(participantId, eventIndex, status);

  // Afficher l'indicateur de synchronisation
  if (syncIndicator) {
    syncIndicator.style.display = 'block';
    syncIndicator.classList.add('syncing');
  }

  // Sauvegarder dans Supabase
  if (supabase) {
    try {
      const { error } = await supabase
        .from('event_validations')
        .upsert({
          participant_id: participantId,
          event_index: eventIndex,
          status: status,
          validated_at: new Date().toISOString()
        });

      if (error) throw error;

      // Synchronisation réussie
      if (syncIndicator) {
        syncIndicator.classList.remove('syncing');
        setTimeout(() => {
          syncIndicator.style.display = 'none';
        }, 1000);
      }

    } catch (error) {
      console.error('Erreur sauvegarde:', error);

      // Afficher l'erreur
      if (syncIndicator) {
        syncIndicator.classList.remove('syncing');
        syncIndicator.classList.add('error');
      }
    }
  }

  // Mettre à jour les statistiques
  updateStatistics();
}

function updateEventDisplay(participantId, eventIndex, status) {
  const eventsList = document.getElementById('eventsList');
  const eventItems = eventsList.querySelectorAll('.event-item');

  if (eventItems[eventIndex]) {
    const eventItem = eventItems[eventIndex];
    const statusElement = eventItem.querySelector('.event-status');

    // Mettre à jour les classes
    eventItem.className = `event-item ${status}`;
    statusElement.className = `event-status ${status}`;
    statusElement.textContent = getStatusLabel(status);
  }
}

// Chargement des données depuis Supabase
async function loadValidationsFromSupabase() {
  if (!supabase) return;

  try {
    const { data, error } = await supabase
      .from('event_validations')
      .select('*');

    if (error) throw error;

    // Mettre à jour les données locales
    data.forEach(validation => {
      const key = `${validation.participant_id}-${validation.event_index}`;
      validationsData[key] = validation.status;
    });

    // Mettre à jour l'affichage si un participant est sélectionné
    if (currentParticipant) {
      const participant = participantsDatabase[currentParticipant];
      if (participant) {
        displayEvents(currentParticipant, participant.evenements);
      }
    }

    updateStatistics();

  } catch (error) {
    console.error('Erreur chargement données:', error);
  }
}

// Subscriptions en temps réel
function initializeRealtimeSubscriptions() {
  if (!supabase) return;

  realtimeChannel = supabase
    .channel('validations')
    .on('postgres_changes',
      { event: '*', schema: 'public', table: 'event_validations' },
      handleRealTimeUpdate
    )
    .subscribe();
}

function handleRealTimeUpdate(payload) {
  const { eventType, new: newRecord, old: oldRecord } = payload;

  if (eventType === 'INSERT' || eventType === 'UPDATE') {
    const key = `${newRecord.participant_id}-${newRecord.event_index}`;
    validationsData[key] = newRecord.status;

    // Mettre à jour l'affichage si c'est le participant actuel
    if (currentParticipant === newRecord.participant_id) {
      updateEventDisplay(newRecord.participant_id, newRecord.event_index, newRecord.status);
    }
  }

  updateStatistics();
}

// Chargement des données locales
function loadValidationsData() {
  // Ici on pourrait charger depuis une source locale si nécessaire
  // Pour l'instant, on initialise avec des données vides
  validationsData = {};
}

// Mise à jour des statistiques
function updateStatistics() {
  const stats = calculateStatistics();

  document.getElementById('totalValidations').textContent = stats.totalValidations;
  document.getElementById('totalInvalidations').textContent = stats.totalInvalidations;
  document.getElementById('validationRate').textContent = `${stats.validationRate}%`;

  displayEventStatistics(stats.eventStats);
}

function calculateStatistics() {
  const stats = {
    totalValidations: 0,
    totalInvalidations: 0,
    validationRate: 0,
    eventStats: {}
  };

  // Analyser toutes les validations
  Object.values(validationsData).forEach(status => {
    if (status === 'validated') {
      stats.totalValidations++;
    } else if (status === 'invalidated') {
      stats.totalInvalidations++;
    }
  });

  // Calculer le taux de validation
  const total = stats.totalValidations + stats.totalInvalidations;
  if (total > 0) {
    stats.validationRate = Math.round((stats.totalValidations / total) * 100);
  }

  // Statistiques par événement
  Object.keys(participantsDatabase).forEach(participantId => {
    const participant = participantsDatabase[participantId];
    participant.evenements.forEach((event, index) => {
      if (!stats.eventStats[event.nom]) {
        stats.eventStats[event.nom] = {
          validated: 0,
          invalidated: 0,
          none: 0
        };
      }

      const status = getEventStatus(participantId, index);
      stats.eventStats[event.nom][status]++;
    });
  });

  return stats;
}

function displayEventStatistics(eventStats) {
  const eventStatsDiv = document.getElementById('eventStats');
  eventStatsDiv.innerHTML = '';

  Object.entries(eventStats).forEach(([eventName, counts]) => {
    const total = counts.validated + counts.invalidated + counts.none;
    const validationRate = total > 0 ? Math.round((counts.validated / total) * 100) : 0;

    const statDiv = document.createElement('div');
    statDiv.className = 'event-stat';
    statDiv.innerHTML = `
      <div class="event-stat-name">${eventName}</div>
      <div class="event-stat-counts">
        <div class="stat-count validated">
          ✓ ${counts.validated}
        </div>
        <div class="stat-count invalidated">
          ✗ ${counts.invalidated}
        </div>
        <div class="stat-count none">
          ○ ${counts.none}
        </div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${validationRate}%"></div>
      </div>
    `;

    eventStatsDiv.appendChild(statDiv);
  });
}

// Test de connexion Supabase
async function testSupabaseConnection() {
  const testButton = document.getElementById('testConnection');
  const resultDiv = document.getElementById('connectionTest');

  testButton.textContent = 'Test en cours...';
  testButton.disabled = true;

  try {
    if (!supabase) {
      throw new Error('Supabase non initialisé');
    }

    // Test simple de lecture
    const { data, error } = await supabase
      .from('event_validations')
      .select('count', { count: 'exact' });

    if (error) throw error;

    resultDiv.textContent = `Connexion réussie! ${data.length} enregistrements trouvés.`;
    resultDiv.className = 'test-result success';

  } catch (error) {
    resultDiv.textContent = `Erreur de connexion: ${error.message}`;
    resultDiv.className = 'test-result error';
  } finally {
    testButton.textContent = 'Tester connexion';
    testButton.disabled = false;
    resultDiv.classList.remove('hidden');
  }
}

// Mise à jour du statut de connexion
function updateConnectionStatus(message, type) {
  const statusElement = document.getElementById('connectionStatus');
  statusElement.textContent = message;
  statusElement.className = `status status--${type}`;
}

// Nettoyage à la fermeture
window.addEventListener('beforeunload', () => {
  if (html5QrCode) {
    html5QrCode.stop().catch(err => console.error('Erreur arrêt scanner:', err));
  }

  if (realtimeChannel) {
    realtimeChannel.unsubscribe();
  }
});
